/*! li3_filemanager - 2012-11-16
	author: Djordje Kovacevic <http://djordjekovacevic.com>
	dependencies: jQuery, Twitter Bootstrap JS
	description: This is JavaScript frontend for li3_filemanager */
var FileManager=FileManager||{};FileManager.token="",FileManager.init=function(e,t){this.Url.set("lib",e.lib),this.Url.set("current",e.current),this.View.Files.data=t.data,this.View.Breadcrumb.data=t.breadcrumb,this.token=$('[name="security[token]"]').val(),this.attachEvents(),this.View.Files.render(),this.View.Breadcrumb.render()},FileManager.ls=function(e,t){$.ajax({url:e,beforeSend:function(){$("body").trigger("loading")},success:function(n){$("body").trigger("loading"),t||(t=!1),t||$(".alert").alert("close"),n.data&&n.breadcrumb&&(FileManager.Url.update(e),FileManager.View.Files.data=n.data,FileManager.View.Breadcrumb.data=n.breadcrumb,FileManager.View.Files.render(),FileManager.View.Breadcrumb.render())}})},FileManager.mkdir=function(e){$.ajax({type:"POST",url:FileManager.Url.params("mkdir",FileManager.Url.params()),data:{new_dir_name:e,token:FileManager.token}}).done(function(e){e.regenerate&&(window.location=FileManager.Url.current),e.success?FileManager.ls(FileManager.Url.current):(FileManager.View.Alert.data=[e],FileManager.View.Alert.render())})},FileManager.upload=function(e){var t=new XMLHttpRequest,n=new FormData;n.append("token",FileManager.token),$.each(e,function(e,t){n.append("files[]",t)}),t.upload.onprogress=function(e){if(e.lengthComputable){var t=e.loaded/e.total*100;$("#upload-proggres").removeClass("hide").find(".bar").css("width",t)}},t.open("POST",FileManager.Url.current,!0),t.onload=function(e){$("#upload-proggres").addClass("hide").find(".bar").css("width",0),e.regenerate&&(window.location=FileManager.Url.current),e.success||(FileManager.View.Alert.data=e.errors,FileManager.View.Alert.render()),FileManager.ls(FileManager.Url.current,!e.success)},t.send(n)},FileManager.move=function(e){$.ajax({type:"POST",url:FileManager.Url.params("move",FileManager.Url.params()),data:{from:e,token:FileManager.token}}).done(function(e){e.regenerate&&(window.location=FileManager.Url.current),e.success||(FileManager.View.Alert.data=e.errors,FileManager.View.Alert.render()),FileManager.ls(FileManager.Url.current,!e.success)})},FileManager.copy=function(e){$.ajax({type:"POST",url:FileManager.Url.params("copy",FileManager.Url.params()),data:{from:e,token:FileManager.token}}).done(function(e){e.regenerate&&(window.location=FileManager.Url.current),e.success||(FileManager.View.Alert.data=e.errors,FileManager.View.Alert.render()),FileManager.ls(FileManager.Url.current,!e.success)})},FileManager.remove=function(e){$.ajax({type:"POST",url:FileManager.Url.params("remove"),data:{selected:e,token:FileManager.token}}).done(function(e){e.regenerate&&(window.location=FileManager.Url.current),e.success||(FileManager.View.Alert.data=e.errors,FileManager.View.Alert.render()),FileManager.ls(FileManager.Url.current,!e.success)})},FileManager.attachEvents=function(){var e=$("body"),t=$("#new-dir-name"),n=$("#files-input"),r=$("#clipboard"),i=$("#loading"),s=$("#paste"),o=$("#m-copy"),u=$("#m-move"),a=$("#m-remove");e.on("click.filemanager",'[data-action="refresh"]',function(t){t.stopPropagation(),t.preventDefault(),FileManager.ls(FileManager.Url.current),e.trigger("disableButtons.filemanager")}),e.on("click.filemanager","#paste",function(e){e.stopPropagation(),e.preventDefault(),FileManager[FileManager.Queue.lastAction](FileManager.Queue.queued),FileManager.Queue.reset(),s.addClass("disabled"),r.empty()}),e.on("click.filemanager","#m-copy",function(t){t.stopPropagation(),t.preventDefault(),$("[name=selector]:checked").each(function(){var e=$(this);FileManager.Queue.add("copy",e.val(),!1),e.attr("checked",!1)}),e.trigger("queued.filemanager")}),e.on("click.filemanager","#m-move",function(t){t.stopPropagation(),t.preventDefault(),$("[name=selector]:checked").each(function(){var e=$(this);FileManager.Queue.add("move",e.val(),!1),e.attr("checked",!1)}),e.trigger("queued.filemanager")}),e.on("click.filemanager","#m-remove",function(t){t.stopPropagation(),t.preventDefault();var n=[];$('[name="selector"]:checked').each(function(){n.push($(this).val())}),FileManager.remove(n),e.trigger("queued.filemanager")}),e.on("click.filemanager","#show-permalink",function(){window.prompt('"Ctrl + C" to copy permalink to this location:',FileManager.Url.current)}),e.on("click.filemanager",'[data-action="fetch"]',function(t){t.stopPropagation(),t.preventDefault(),FileManager.ls($(this).attr("href")),e.trigger("disableButtons.filemanager")}),e.on("click.filemanager",'[data-action="remove"]',function(e){e.stopPropagation(),e.preventDefault(),FileManager.remove([$(this).attr("data-path")])}),e.on("click.filemanager",'[data-action="copy"]',function(t){t.stopPropagation(),t.preventDefault(),FileManager.Queue.add("copy",$(this).attr("data-path"),!0),e.trigger("queued.filemanager")}),e.on("click.filemanager",'[data-action="move"]',function(t){t.stopPropagation(),t.preventDefault(),FileManager.Queue.add("move",$(this).attr("data-path"),!0),e.trigger("queued.filemanager")}),e.on("change.filemanager","[name=selector]",function(){var t=$('[name="selector"]:checked');t.length>0?e.trigger("enableButtons"):e.trigger("disableButtons")}),e.on("submit.filemanager","#create-folder",function(e){e.stopPropagation(),e.preventDefault();var t=$(this);FileManager.mkdir(t.find('[name="new_dir_name"]').val()),t[0].reset()}),e.on("submit.filemanager","#upload-files",function(e){e.preventDefault();if(!$.browser.msie||$.browser.msie&&parseInt($.browser.version,10)>9)FileManager.upload(n[0].files),$(this)[0].reset();else{var t=$(this);t.attr("action",FileManager.Url.current),t.append('<input type="hidden" name="token" value="'+FileManager.token+'" />'),t[0].submit()}}),e.on("show","#create-folder-wrapper",function(){t.focus()}),e.on("click.filemanager",'[data-action="clipboard-remove"]',function(){FileManager.Queue.remove($(this).attr("data-path")),e.trigger("queued.filemanager")}),e.on("click.filemanager",'[data-action="clear-clipboard"]',function(){FileManager.Queue.reset(),e.trigger("queued.filemanager")}),e.on("queued.filemanager",function(){FileManager.View.Clipboard.render(),FileManager.Queue.queued.length?s.removeClass("disabled"):s.addClass("disabled"),e.trigger("disableButtons.filemanager")}),e.on("enableButtons.filemanager",function(){o.removeClass("disabled"),u.removeClass("disabled"),a.removeClass("disabled")}),e.on("disableButtons.filemanager",function(){o.addClass("disabled"),u.addClass("disabled"),a.addClass("disabled")}),e.on("loading.filemanager",function(){i.toggleClass("hide")})},FileManager.Queue={lastAction:"",allowedActions:["copy","move","remove"],queued:[],add:function(e,t,n){var r=!1;if(!e||!t)return!1;!n||this.reset();for(var i=this.allowedActions.length-1;i>=0;i--)if(this.allowedActions[i]===e){this.lastAction=e;for(var s=this.queued.length-1;s>=0;s--)this.queued[s]===t&&(r=!0)}return r?!1:this.queued.push(t)},remove:function(e){if(this.last_action==="")return!1;for(var t=this.queued.length-1;t>=0;t--)if(this.queued[t]===e)return!this.queued.splice(t,1)},reset:function(){this.lastAction="",this.actionExists=!1,this.queued=[]}},FileManager.Url={lib:"",current:"",trim:function(e){while(e.charAt(0)==="/")e=e.substr(1);while(e.charAt(e.length-1)==="/")e=e.substr(0,e.length-1);return e},filter:function(e){var t;switch(typeof e){case"string":t=this.trim(e);break;case"object":$.each(e,function(e,n){t[e]=this.filter(n)}),t=t.join("/")}return t},set:function(e,t){return typeof this[e]=="string"&&this[e]===""&&t?this[e]=this.trim(t):!1},update:function(e){return this.current=this.trim(e)},params:function(){var e=arguments.length,t=[];if(e<1)return this.trim(this.current.substring(this.current.length,this.lib.length));for(var n=e-1;n>=0;n--)t[n]=this.filter(arguments[n]);return this.lib+"/"+escape(t.join("/"))}},FileManager.View={},FileManager.View.Alert={selector:"#alerts",template:"{{#data}}{{{element}}}{{/data}}",element:function(){var e='<div class="alert">';return e+='<button type="button" class="close" data-dismiss="alert">Ã—</button>',e+=this.error,e+="</div>",e},data:null,render:function(){typeof this.selector=="string"&&(this.selector=$(this.selector)),this.selector.empty().append(Mustache.render(this.template,this))}},FileManager.View.Breadcrumb={selector:".breadcrumb",template:'<li><i class="icon-folder-close"></i><span class="divider">:</span></li>{{#data}}<li>{{{element}}}</li>{{/data}}',element:function(){return this.url?'<a href="'+this.url+'" data-action="fetch">'+this[0]+'</a><span class="divider">/</span>':this[0]},data:null,render:function(){typeof this.selector=="string"&&(this.selector=$(this.selector)),this.selector.empty().append(Mustache.render(this.template,this))}},FileManager.View.Clipboard={selector:"#clipboard",template:"{{#data}}{{{element}}}{{/data}}",element:function(){var e='<div class="clearfix">';return e+='<p class="pull-left">'+this+"</p>",e+='<button type="button" class="btn btn-mini btn-warning pull-right" title="Remove from clipboard" data-action="clipboard-remove" data-path="'+this+'"><i class="icon-trash icon-white"></i></button>',e+="</div>",e},data:function(){return FileManager.Queue.queued},render:function(){typeof this.selector=="string"&&(this.selector=$(this.selector)),this.selector.empty().append(Mustache.render(this.template,this))}},FileManager.View.Files={selector:"#files",template:"{{#data}}{{{element}}}{{/data}}",element:function(){var e=this.path==="/"?this.path+this.name:this.path+"/"+this.name,t="<tr>";t+='<td><input type="checkbox" name="selector" value="'+e+'"/></td>',t+="<td><strong>",this.dir?t+='<a href="'+FileManager.Url.params(e)+'" data-action="fetch">'+this.name+"</a>":t+=this.name,t+="</strong></td>",t+="<td>";if(!this.dir){var n=Math.round(this.size/1024);t+=n+" KB"}return t+="</td>",t+="<td>"+this.mode+"</td>",t+='<td><div class="btn-group">',this.url&&(t+='<a href="'+this.url+'" class="btn btn-small',this.dir&&(t+=" disabled"),t+='" target="_blank">Open URL</a>'),t+='<button type="button" class="btn btn-small" title="Copy" data-action="copy" data-path="'+e+'">Copy</button>',t+='<button type="button" class="btn btn-small" title="Cut" data-action="move" data-path="'+e+'">Cut</button>',t+='<button type="button" class="btn btn-small btn-danger" title="Delete"  data-action="remove" data-path="'+e+'"><i class="icon-trash icon-white"></i></button>',t+="</div></td></tr>",t},data:null,render:function(){typeof this.selector=="string"&&(this.selector=$(this.selector)),this.selector.empty().append(Mustache.render(this.template,this))}};