/*! li3_filemanager - 2012-09-02
	author: Djordje Kovacevic <http://djordjekovacevic.com>
	dependencies: jQuery, Twitter Bootstrap JS
	description: This is JavaScript frontend for li3_filemanager */
var FileManager=FileManager||{};FileManager.token="",FileManager.init=function(a,b){this.Url.set("lib",a.lib),this.Url.set("current",a.current),this.View.Files.data=b.data,this.View.Breadcrumb.data=b.breadcrumb,this.token=$('[name="security[token]"]').val(),this.attachEvents(),this.View.Files.render(),this.View.Breadcrumb.render()},FileManager.ls=function(a,b){$.ajax({url:a,beforeSend:function(){$("body").trigger("loading")},success:function(c){$("body").trigger("loading"),b||(b=!1),b||$(".alert").alert("close"),c.data&&c.breadcrumb&&(FileManager.Url.update(a),FileManager.View.Files.data=c.data,FileManager.View.Breadcrumb.data=c.breadcrumb,FileManager.View.Files.render(),FileManager.View.Breadcrumb.render())}})},FileManager.mkdir=function(a){$.ajax({type:"POST",url:FileManager.Url.params("mkdir",FileManager.Url.params()),data:{new_dir_name:a,token:FileManager.token}}).done(function(a){a.regenerate&&(window.location=FileManager.Url.current),a.success?FileManager.ls(FileManager.Url.current):(FileManager.View.Alert.data=[a],FileManager.View.Alert.render())})},FileManager.upload=function(a){var b=new XMLHttpRequest,c=new FormData;c.append("token",FileManager.token),$.each(a,function(a,b){c.append("files[]",b)}),b.upload.onprogress=function(a){if(a.lengthComputable){var b=a.loaded/a.total*100;$("#upload-proggres").removeClass("hide").find(".bar").css("width",b)}},b.open("POST",FileManager.Url.current,!0),b.onload=function(a){$("#upload-proggres").addClass("hide").find(".bar").css("width",0),a.regenerate&&(window.location=FileManager.Url.current),a.success||(FileManager.View.Alert.data=a.errors,FileManager.View.Alert.render()),FileManager.ls(FileManager.Url.current,!a.success)},b.send(c)},FileManager.move=function(a){$.ajax({type:"POST",url:FileManager.Url.params("move",FileManager.Url.params()),data:{from:a,token:FileManager.token}}).done(function(a){a.regenerate&&(window.location=FileManager.Url.current),a.success||(FileManager.View.Alert.data=a.errors,FileManager.View.Alert.render()),FileManager.ls(FileManager.Url.current,!a.success)})},FileManager.copy=function(a){$.ajax({type:"POST",url:FileManager.Url.params("copy",FileManager.Url.params()),data:{from:a,token:FileManager.token}}).done(function(a){a.regenerate&&(window.location=FileManager.Url.current),a.success||(FileManager.View.Alert.data=a.errors,FileManager.View.Alert.render()),FileManager.ls(FileManager.Url.current,!a.success)})},FileManager.remove=function(a){$.ajax({type:"POST",url:FileManager.Url.params("remove"),data:{selected:a,token:FileManager.token}}).done(function(a){a.regenerate&&(window.location=FileManager.Url.current),a.success||(FileManager.View.Alert.data=a.errors,FileManager.View.Alert.render()),FileManager.ls(FileManager.Url.current,!a.success)})},FileManager.attachEvents=function(){var a=$("body"),b=$("#new-dir-name"),c=$("#files-input"),d=$("#clipboard"),e=$("#loading"),f=$("#paste"),g=$("#m-copy"),h=$("#m-move"),i=$("#m-remove");a.on("click.filemanager",'[data-action="refresh"]',function(b){b.stopPropagation(),b.preventDefault(),FileManager.ls(FileManager.Url.current),a.trigger("disableButtons.filemanager")}),a.on("click.filemanager","#paste",function(a){a.stopPropagation(),a.preventDefault(),FileManager[FileManager.Queue.lastAction](FileManager.Queue.queued),FileManager.Queue.reset(),f.addClass("disabled"),d.empty()}),a.on("click.filemanager","#m-copy",function(b){b.stopPropagation(),b.preventDefault(),$("[name=selector]:checked").each(function(){var a=$(this);FileManager.Queue.add("copy",a.val(),!1),a.attr("checked",!1)}),a.trigger("queued.filemanager")}),a.on("click.filemanager","#m-move",function(b){b.stopPropagation(),b.preventDefault(),$("[name=selector]:checked").each(function(){var a=$(this);FileManager.Queue.add("move",a.val(),!1),a.attr("checked",!1)}),a.trigger("queued.filemanager")}),a.on("click.filemanager","#m-remove",function(b){b.stopPropagation(),b.preventDefault();var c=[];$('[name="selector"]:checked').each(function(){c.push($(this).val())}),FileManager.remove(c),a.trigger("queued.filemanager")}),a.on("click.filemanager","#show-permalink",function(){window.prompt('"Ctrl + C" to copy permalink to this location:',FileManager.Url.current)}),a.on("click.filemanager",'[data-action="fetch"]',function(b){b.stopPropagation(),b.preventDefault(),FileManager.ls($(this).attr("href")),a.trigger("disableButtons.filemanager")}),a.on("click.filemanager",'[data-action="remove"]',function(a){a.stopPropagation(),a.preventDefault(),FileManager.remove([$(this).attr("data-path")])}),a.on("click.filemanager",'[data-action="copy"]',function(b){b.stopPropagation(),b.preventDefault(),FileManager.Queue.add("copy",$(this).attr("data-path"),!0),a.trigger("queued.filemanager")}),a.on("click.filemanager",'[data-action="move"]',function(b){b.stopPropagation(),b.preventDefault(),FileManager.Queue.add("move",$(this).attr("data-path"),!0),a.trigger("queued.filemanager")}),a.on("change.filemanager","[name=selector]",function(){var b=$('[name="selector"]:checked');b.length>0?a.trigger("enableButtons"):a.trigger("disableButtons")}),a.on("submit.filemanager","#create-folder",function(a){a.stopPropagation(),a.preventDefault();var b=$(this);FileManager.mkdir(b.find('[name="new_dir_name"]').val()),b[0].reset()}),a.on("submit.filemanager","#upload-files",function(a){a.preventDefault();if(!$.browser.msie||$.browser.msie&&parseInt($.browser.version,10)>9)FileManager.upload(c[0].files),$(this)[0].reset();else{var b=$(this);b.attr("action",FileManager.Url.current),b.append('<input type="hidden" name="token" value="'+FileManager.token+'" />'),b[0].submit()}}),a.on("show","#create-folder-wrapper",function(){b.focus()}),a.on("click.filemanager",'[data-action="clipboard-remove"]',function(){FileManager.Queue.remove($(this).attr("data-path")),a.trigger("queued.filemanager")}),a.on("click.filemanager",'[data-action="clear-clipboard"]',function(){FileManager.Queue.reset(),a.trigger("queued.filemanager")}),a.on("queued.filemanager",function(){FileManager.View.Clipboard.render(),FileManager.Queue.queued.length?f.removeClass("disabled"):f.addClass("disabled"),a.trigger("disableButtons.filemanager")}),a.on("enableButtons.filemanager",function(){g.removeClass("disabled"),h.removeClass("disabled"),i.removeClass("disabled")}),a.on("disableButtons.filemanager",function(){g.addClass("disabled"),h.addClass("disabled"),i.addClass("disabled")}),a.on("loading.filemanager",function(){e.toggleClass("hide")})},FileManager.Queue={lastAction:"",allowedActions:["copy","move","remove"],actionExists:!1,queued:[],add:function(a,b,c){var d=!1;if(!a||!b)return!1;!c||this.reset();for(var e=this.allowedActions.length-1;e>=0;e--)this.allowedActions[e]===a&&(this.actionExists=!0);if(!this.actionExists)return!1;this.lastAction=a,this.actionExists=!1;for(var f=this.queued.length-1;f>=0;f--)this.queued[f]===b&&(d=!0);return d?!1:this.queued.push(b)},remove:function(a){if(this.last_action==="")return!1;for(var b=this.queued.length-1;b>=0;b--)if(this.queued[b]===a)return!this.queued.splice(b,1)},reset:function(){this.lastAction="",this.actionExists=!1,this.queued=[]}},FileManager.Url={lib:"",current:"",trim:function(a){while(a.charAt(0)==="/")a=a.substr(1);while(a.charAt(a.length-1)==="/")a=a.substr(0,a.length-1);return a},filter:function(a){var b;switch(typeof a){case"string":b=this.trim(a);break;case"object":$.each(a,function(a,c){b[a]=this.filter(c)}),b=b.join("/")}return b},set:function(a,b){return typeof this[a]=="string"&&this[a]===""&&b?this[a]=this.trim(b):!1},update:function(a){return this.current=this.trim(a)},params:function(){var a=arguments.length,b=[];if(a<1)return this.trim(this.current.substring(this.current.length,this.lib.length));for(var c=a-1;c>=0;c--)b[c]=this.filter(arguments[c]);return this.lib+"/"+escape(b.join("/"))}},FileManager.View={},FileManager.View.Alert={selector:"#alerts",template:"{{#data}}{{{element}}}{{/data}}",element:function(){var a='<div class="alert">';return a+='<button type="button" class="close" data-dismiss="alert">Ã—</button>',a+=this.error,a+="</div>",a},data:null,render:function(){typeof this.selector=="string"&&(this.selector=$(this.selector)),this.selector.empty().append(Mustache.render(this.template,this))}},FileManager.View.Breadcrumb={selector:".breadcrumb",template:'<li><i class="icon-folder-close"></i><span class="divider">:</span></li>{{#data}}<li>{{{element}}}</li>{{/data}}',element:function(){return this.url?'<a href="'+this.url+'" data-action="fetch">'+this[0]+'</a><span class="divider">/</span>':this[0]},data:null,render:function(){typeof this.selector=="string"&&(this.selector=$(this.selector)),this.selector.empty().append(Mustache.render(this.template,this))}},FileManager.View.Clipboard={selector:"#clipboard",template:"{{#data}}{{{element}}}{{/data}}",element:function(){var a='<div class="clearfix">';return a+='<p class="pull-left">'+this+"</p>",a+='<button type="button" class="btn btn-mini btn-warning pull-right" title="Remove from clipboard" data-action="clipboard-remove" data-path="'+this+'"><i class="icon-trash icon-white"></i></button>',a+="</div>",a},data:function(){return FileManager.Queue.queued},render:function(){typeof this.selector=="string"&&(this.selector=$(this.selector)),this.selector.empty().append(Mustache.render(this.template,this))}},FileManager.View.Files={selector:"#files",template:"{{#data}}{{{element}}}{{/data}}",element:function(){var a=this.path==="/"?this.path+this.name:this.path+"/"+this.name,b="<tr>";b+='<td><input type="checkbox" name="selector" value="'+a+'"/></td>',b+="<td><strong>",this.dir?b+='<a href="'+FileManager.Url.params(a)+'" data-action="fetch">'+this.name+"</a>":b+=this.name,b+="</strong></td>",b+="<td>";if(!this.dir){var c=Math.round(this.size/1024);b+=c+" KB"}return b+="</td>",b+="<td>"+this.mode+"</td>",b+='<td><div class="btn-group">',this.url&&(b+='<a href="'+this.url+'" class="btn btn-small',this.dir&&(b+=" disabled"),b+='" target="_blank">Open URL</a>'),b+='<button type="button" class="btn btn-small" title="Copy" data-action="copy" data-path="'+a+'">Copy</button>',b+='<button type="button" class="btn btn-small" title="Cut" data-action="move" data-path="'+a+'">Cut</button>',b+='<button type="button" class="btn btn-small btn-danger" title="Delete"  data-action="remove" data-path="'+a+'"><i class="icon-trash icon-white"></i></button>',b+="</div></td><tr/>",b},data:null,render:function(){typeof this.selector=="string"&&(this.selector=$(this.selector)),this.selector.empty().append(Mustache.render(this.template,this))}};