/* ==========================================================
 * li3_filemanager v0.1.0
 * Author: Djordje Kovacevic <http://djordjekovacevic.com>
 * Description: This is JavaScript frontend for li3_filemanager
 * ========================================================== */

var FileManager=FileManager||{};(function(e){e.View={},e.token="",e.url=null,e.VERSION="0.1.0";var t=function(e,t){this.lib=this.filter(e)||"",this.current=this.filter(t)||""};t.prototype={constructor:t,trim:function(e){while(e.charAt(0)==="/")e=e.substr(1);while(e.charAt(e.length-1)==="/")e=e.substr(0,e.length-1);return e},filter:function(e){switch(typeof e){case"string":return this.trim(e);case"object":var t=[],n=this;return $.each(e,function(e,r){t[e]=n.filter(r)}),t.join("/")}},set:function(e){return this.current=this.filter(e)},params:function(){var e=arguments.length,t=[];if(e<1)return this.trim(this.current.substring(this.current.length,this.lib.length));for(var n=e;n>=0;n--)t[n]=this.filter(arguments[n]);return this.lib+"/"+escape(this.trim(t.join("/")))}};var n={lastAction:"",allowedActions:["copy","move","remove"],queued:[],add:function(e,t,n){var r=!1;if(!e||!t)return!1;!n||this.reset();for(var i=this.allowedActions.length-1;i>=0;i--)if(this.allowedActions[i]===e){this.lastAction=e;for(var s=this.queued.length-1;s>=0;s--)this.queued[s]===t&&(r=!0)}return r?!1:this.queued.push(t)},remove:function(e){if(this.lastAction!==""){var t=$.inArray(e,this.queued);if(t>=0)return this.queued.splice(t,1),!0}return!1},reset:function(){this.lastAction="",this.queued=[]}},r=function(e,t,n,r){this.selector=e||"",this.data=t||null,this.element=n||function(){return""},this.template=r||"{{#data}}{{{element}}}{{/data}}"};r.prototype={update:function(e){this.data=e||null,this.render()},render:function(){typeof this.selector=="string"&&(this.selector=$(this.selector)),this.selector.empty().append(Mustache.render(this.template,this))}},e.View.Alert=new r("#alerts",null,function(){var e='<div class="alert">';return e+='<button type="button" class="close" data-dismiss="alert">Ã—</button>',e+=this.error,e+="</div>",e}),e.View.Breadcrumb=new r(".breadcrumb",null,function(){return this.url?'<a href="'+this.url+'" data-action="fetch">'+this[0]+'</a><span class="divider">/</span>':this[0]},'<li><i class="icon-folder-close"></i><span class="divider">:</span></li>{{#data}}<li>{{{element}}}</li>{{/data}}'),e.View.Clipboard=new r("#clipboard",function(){return e.queue.queued},function(){var e='<div class="clearfix">';return e+='<p class="pull-left">'+this+"</p>",e+='<button type="button" class="btn btn-mini btn-warning pull-right" title="Remove from clipboard" data-action="clipboard-remove" data-path="'+this+'"><i class="icon-trash icon-white"></i></button>',e+="</div>",e}),e.View.Files=new r("#files",null,function(){var t=this.path==="/"?this.path+this.name:this.path+"/"+this.name,n="<tr>";n+='<td><input type="checkbox" name="selector" value="'+t+'"/></td>',n+="<td><strong>",this.dir?n+='<a href="'+e.url.params(t)+'" data-action="fetch">'+this.name+"</a>":n+=this.name,n+="</strong></td>",n+="<td>";if(!this.dir){var r=Math.round(this.size/1024);n+=r+" KB"}return n+="</td>",n+="<td>"+this.mode+"</td>",n+='<td><div class="btn-group">',this.url&&(n+='<a href="'+this.url+'" class="btn btn-small',this.dir&&(n+=" disabled"),n+='" target="_blank">Open URL</a>'),n+='<button type="button" class="btn btn-small" title="Copy" data-action="copy" data-path="'+t+'">Copy</button>',n+='<button type="button" class="btn btn-small" title="Cut" data-action="move" data-path="'+t+'">Cut</button>',n+='<button type="button" class="btn btn-small btn-danger" title="Delete"  data-action="remove" data-path="'+t+'"><i class="icon-trash icon-white"></i></button>',n+="</div></td></tr>",n}),e.ls=function(t,n){$.ajax({url:t,beforeSend:function(){$("body").trigger("loading")},success:function(r){$("body").trigger("loading"),n||(n=!1),n||$(".alert").alert("close"),r.data&&r.breadcrumb&&(e.url.set(t),e.View.Files.update(r.data),e.View.Breadcrumb.update(r.breadcrumb))}})},e.mkdir=function(t){$.ajax({type:"POST",url:e.url.params("mkdir",e.url.params()),data:{new_dir_name:t,token:e.token}}).done(function(t){t.regenerate&&(window.location=e.url.current),t.success?e.ls(e.url.current):e.View.Alert.update([t])})},e.upload=function(t){var n=new XMLHttpRequest,r=new FormData;r.append("token",e.token),$.each(t,function(e,t){r.append("files[]",t)}),n.upload.onprogress=function(e){if(e.lengthComputable){var t=e.loaded/e.total*100;$("#upload-proggres").removeClass("hide").find(".bar").css("width",t)}},n.open("POST",e.url.current,!0),n.onload=function(t){$("#upload-proggres").addClass("hide").find(".bar").css("width",0),t.regenerate&&(window.location=e.url.current),t.success||e.View.Alert.update(t.errors),e.ls(e.url.current,!t.success)},n.send(r)},e.move=function(t){$.ajax({type:"POST",url:e.url.params("move",e.url.params()),data:{from:t,token:e.token}}).done(function(t){t.regenerate&&(window.location=e.url.current),t.success||e.View.Alert.update(t.errors),e.ls(e.url.current,!t.success)})},e.copy=function(t){$.ajax({type:"POST",url:e.url.params("copy",e.url.params()),data:{from:t,token:e.token}}).done(function(t){t.regenerate&&(window.location=e.url.current),t.success||e.View.Alert.update(t.errors),e.ls(e.url.current,!t.success)})},e.remove=function(t){$.ajax({type:"POST",url:e.url.params("remove"),data:{selected:t,token:e.token}}).done(function(t){t.regenerate&&(window.location=e.url.current),t.success||e.View.Alert.update(t.errors),e.ls(e.url.current,!t.success)})},e.attachEvents=function(){var t=$("body"),n=$("#new-dir-name"),r=$("#files-input"),i=$("#clipboard"),s=$("#loading"),o=$("#paste"),u=$("#m-copy"),a=$("#m-move"),f=$("#m-remove");t.on("click.filemanager",'[data-action="refresh"]',function(n){n.stopPropagation(),n.preventDefault(),e.ls(e.url.current),t.trigger("disableButtons.filemanager")}),t.on("click.filemanager","#paste",function(t){t.stopPropagation(),t.preventDefault(),e[e.queue.lastAction](e.queue.queued),e.queue.reset(),o.addClass("disabled"),i.empty()}),t.on("click.filemanager","#m-copy",function(n){n.stopPropagation(),n.preventDefault(),$("[name=selector]:checked").each(function(){var t=$(this);e.queue.add("copy",t.val(),!1),t.attr("checked",!1)}),t.trigger("queued.filemanager")}),t.on("click.filemanager","#m-move",function(n){n.stopPropagation(),n.preventDefault(),$("[name=selector]:checked").each(function(){var t=$(this);e.queue.add("move",t.val(),!1),t.attr("checked",!1)}),t.trigger("queued.filemanager")}),t.on("click.filemanager","#m-remove",function(n){n.stopPropagation(),n.preventDefault();var r=[];$('[name="selector"]:checked').each(function(){r.push($(this).val())}),e.remove(r),t.trigger("queued.filemanager")}),t.on("click.filemanager","#show-permalink",function(){window.prompt('"Ctrl + C" to copy permalink to this location:',e.url.current)}),t.on("click.filemanager",'[data-action="fetch"]',function(n){n.stopPropagation(),n.preventDefault(),e.ls($(this).attr("href")),t.trigger("disableButtons.filemanager")}),t.on("click.filemanager",'[data-action="remove"]',function(t){t.stopPropagation(),t.preventDefault(),e.remove([$(this).attr("data-path")])}),t.on("click.filemanager",'[data-action="copy"]',function(n){n.stopPropagation(),n.preventDefault(),e.queue.add("copy",$(this).attr("data-path"),!0),t.trigger("queued.filemanager")}),t.on("click.filemanager",'[data-action="move"]',function(n){n.stopPropagation(),n.preventDefault(),e.queue.add("move",$(this).attr("data-path"),!0),t.trigger("queued.filemanager")}),t.on("change.filemanager","[name=selector]",function(){var e=$('[name="selector"]:checked');e.length>0?t.trigger("enableButtons"):t.trigger("disableButtons")}),t.on("submit.filemanager","#create-folder",function(t){t.stopPropagation(),t.preventDefault();var n=$(this);e.mkdir(n.find('[name="new_dir_name"]').val()),n[0].reset()}),t.on("submit.filemanager","#upload-files",function(t){t.preventDefault();if(!$.browser.msie||$.browser.msie&&parseInt($.browser.version,10)>9)e.upload(r[0].files),$(this)[0].reset();else{var n=$(this);n.attr("action",e.url.current),n.append('<input type="hidden" name="token" value="'+e.token+'" />'),n[0].submit()}}),t.on("show","#create-folder-wrapper",function(){n.focus()}),t.on("click.filemanager",'[data-action="clipboard-remove"]',function(){e.queue.remove($(this).attr("data-path")),t.trigger("queued.filemanager")}),t.on("click.filemanager",'[data-action="clear-clipboard"]',function(){e.queue.reset(),t.trigger("queued.filemanager")}),t.on("queued.filemanager",function(){e.View.Clipboard.render(),e.queue.queued.length?o.removeClass("disabled"):o.addClass("disabled"),t.trigger("disableButtons.filemanager")}),t.on("enableButtons.filemanager",function(){u.removeClass("disabled"),a.removeClass("disabled"),f.removeClass("disabled")}),t.on("disableButtons.filemanager",function(){u.addClass("disabled"),a.addClass("disabled"),f.addClass("disabled")}),t.on("loading.filemanager",function(){s.toggleClass("hide")})},e.queue=n,e.init=function(e,n,r){this.url=new t(e.lib,e.current),this.token=r,this.View.Files.data=n.data,this.View.Breadcrumb.data=n.breadcrumb,this.attachEvents(),this.View.Files.render(),this.View.Breadcrumb.render()}})(FileManager);